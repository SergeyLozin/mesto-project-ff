(()=>{"use strict";function e(e){e.classList.add("popup_is-opened"),document.addEventListener("keydown",r)}function t(e){e.classList.remove("popup_is-opened"),document.removeEventListener("keydown",r)}function r(e){if("Escape"===e.key){const e=document.querySelector(".popup_is-opened");e&&t(e)}}function o(e){const r=e.querySelector(".popup__close");r&&r.addEventListener("click",(()=>t(e))),function(e){e.addEventListener("click",(r=>{r.target===e&&t(e)}))}(e)}function n(e,t,r,o,n){const c=document.querySelector("#card-template").content.querySelector(".card").cloneNode(!0),a=c.querySelector(".card__image");a.src=e.link,a.alt=e.name,c.querySelector(".card__title").textContent=e.name;const i=c.querySelector(".card__delete-button");e.owner._id!==n?i.style.display="none":i.addEventListener("click",t);const s=c.querySelector(".card__like-button"),u=c.querySelector(".card__like-count");return u.textContent=e.likes.length,e.likes.some((e=>e._id===n))&&s.classList.add("card__like-button_is-active"),s.addEventListener("click",(()=>{r(s,e._id,u)})),a.addEventListener("click",(()=>{o(e)})),c}function c(e){e.target.closest(".card").remove()}const a={formSelector:".popup__form",inputSelector:".popup__input",submitButtonSelector:".popup__button",inactiveButtonClass:"popup__button_inactive",inputErrorClass:"popup__input_type_error",errorClass:"form__input-error_active"},i=(e,t,r)=>{const o=e.querySelector(`.${t.id}-error`);t.classList.remove(r.inputErrorClass),o.classList.remove(r.errorClass),o.textContent=""},s=(e,t,r)=>{(e=>e.some((e=>!e.validity.valid)))(e)?(t.disabled=!0,t.classList.add(r)):(t.disabled=!1,t.classList.remove(r))},u=(e,t)=>{const r=Array.from(e.querySelectorAll(t.inputSelector)),o=e.querySelector(t.submitButtonSelector);r.forEach((r=>{i(e,r,t)})),s(r,o,t.inactiveButtonClass)},l={baseUrl:"https://nomoreparties.co/v1/wff-cohort-37",headers:{authorization:"d31f61de-0975-44cc-9988-d24422d9cf34","Content-Type":"application/json"}};function d(e){return e.ok?e.json():Promise.reject(`Ошибка: ${e.status}`)}function p(e,t,r){const o=e.classList.contains("card__like-button_is-active");fetch(`https://nomoreparties.co/v1/wff-cohort-37/cards/likes/${t}`,{method:o?"DELETE":"PUT",headers:{authorization:"d31f61de-0975-44cc-9988-d24422d9cf34","Content-Type":"application/json"}}).then((e=>e.json())).then((t=>{e.classList.toggle("card__like-button_is-active"),r.textContent=t.likes.length})).catch((e=>console.error("Ошибка при обновлении лайка:",e)))}let _;(e=>{Array.from(document.querySelectorAll(e.formSelector)).forEach((t=>{t.addEventListener("submit",(e=>{e.preventDefault()})),((e,t)=>{const r=Array.from(e.querySelectorAll(t.inputSelector)),o=e.querySelector(t.submitButtonSelector);s(r,o,t.inactiveButtonClass),r.forEach((n=>{n.addEventListener("input",(()=>{((e,t,r)=>{t.validity.valid?i(e,t,r):((e,t,r,o)=>{const n=e.querySelector(`.${t.id}-error`);t.classList.add(o.inputErrorClass);const c=t.dataset.errorMessage||r;n.textContent=c,n.classList.add(o.errorClass)})(e,t,t.validationMessage,r)})(e,n,t),s(r,o,t.inactiveButtonClass)}))}))})(t,e)}))})(a);const m=document.querySelector(".places__list"),y=document.querySelector(".popup_type_edit"),f=document.querySelector(".popup_type_new-card"),v=document.querySelector('[name="edit-profile"]'),h=document.querySelector('[name="new-place"]'),S=document.querySelector(".popup__input_type_name"),q=document.querySelector(".popup__input_type_description"),b=document.querySelector(".popup__input_type_card-name"),C=document.querySelector(".popup__input_type_url"),L=document.querySelector(".popup_type_avatar"),E=document.querySelector('[name="edit-avatar"]'),k=document.querySelector(".popup__input_type_url"),g=document.querySelector(".profile__image");function x(t){const r=document.querySelector(".popup_type_image"),o=r.querySelector(".popup__image"),n=r.querySelector(".popup__caption");o.src=t.link,o.alt=t.name,n.textContent=t.name,e(r)}document.querySelector(".profile__edit-avatar").addEventListener("click",(()=>{k.value="",u(E,a),e(L)})),E.addEventListener("submit",(function(e){e.preventDefault();const r=new FormData(e.target).get("avatar").trim();if(!r)return void alert("Введите ссылку на аватар!");if(!r.startsWith("http"))return void alert("URL должен начинаться с http:// или https://");const o=e.submitter;o.textContent="Сохранение...",(e=>fetch(`${l.baseUrl}/users/me/avatar`,{method:"PATCH",headers:l.headers,body:JSON.stringify({avatar:e})}).then(d))(r).then((e=>{g.style.backgroundImage=`url('${e.avatar}')`,t(L)})).catch((e=>{alert("Сервер отклонил URL. Попробуйте другую ссылку.")})).finally((()=>{o.textContent="Сохранить"}))})),Promise.all([fetch(`${l.baseUrl}/users/me`,{headers:l.headers}).then(d),fetch(`${l.baseUrl}/cards`,{headers:l.headers}).then(d)]).then((([e,t])=>{_=e._id,document.querySelector(".profile__title").textContent=e.name,document.querySelector(".profile__description").textContent=e.about,t.forEach((e=>{const t=n(e,c,p,x,_);m.append(t)}))})).catch((e=>{alert("Ошибка при загрузке")})),document.querySelector(".profile__edit-button").addEventListener("click",(function(){S.value=document.querySelector(".profile__title").textContent,q.value=document.querySelector(".profile__description").textContent,u(v,a),e(y)})),o(y),document.querySelector(".profile__add-button").addEventListener("click",(function(){h.reset(),e(f)})),o(f),v.addEventListener("submit",(function(e){e.preventDefault();const r=e.submitter,o=r.textContent;r.textContent="Сохранение...";var n,c;(n=S.value,c=q.value,fetch(`${l.baseUrl}/users/me`,{method:"PATCH",headers:l.headers,body:JSON.stringify({name:n,about:c})}).then(d)).then((e=>{document.querySelector(".profile__title").textContent=e.name,document.querySelector(".profile__description").textContent=e.about,t(y)})).catch((e=>{alert("Не удалось обновить профиль. Попробуйте ещё раз.")})).finally((()=>{r.textContent=o}))})),h.addEventListener("submit",(function(e){e.preventDefault();const r=e.submitter,o=r.textContent;var i,s;r.textContent="Сохранение...",(i=b.value,s=C.value,fetch(`${l.baseUrl}/cards`,{method:"POST",headers:l.headers,body:JSON.stringify({name:i,link:s})}).then(d)).then((e=>{const r=n(e,c,p,x,_);m.prepend(r),h.reset(),u(h,a),t(f)})).catch((e=>console.error("Ошибка при создании карточки:",e))).finally((()=>{r.textContent=o}))})),o(document.querySelector(".popup_type_image"))})();